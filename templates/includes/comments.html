{% if ISSO_ENABLED and article.status != "draft" %}
    <script src="/theme/isso/embed.dev.js"></script>
    <section id="isso-thread"></section>
{% endif %}
{% if DISQUS_SITENAME and article.status != "draft" %}
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = '{{ DISQUS_SITENAME }}';
        var disqus_identifier = '{{ article.slug }}';
        var disqus_title = '{{ article.title|striptags }}';
        var disqus_url = '{{ SITEURL }}/{{ article.url }}';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
{% endif %}
{% if PELICAN_COMMENT_SYSTEM and article.status != "draft" %}
    <section id="comments">
        <script>
            function reply(id) {
                id = decodeURIComponent(id);
                $('#commentForm_replyto').val(id);
            }

            $(document).ready(function() {
                function generateMailToLink() {
                    var user = 'ron'; //user@domain = your email address
                    var domain = 'tohuw.net';
                    var subject = 'New Comment for \"{{ article.title|striptags }}\" on {{ SITENAME }}';

                    var d = new Date();
                    var body = ''
                        + 'Hey,\nI posted a new comment on ' + document.URL + '\n\nGreetings ' + $("#commentForm_inputName").val() + '\n\n\n'
                        + 'Raw comment data:\n'
                        + '----------------------------------------\n'
                        + 'date: ' + d.getFullYear() + '-' + (d.getMonth()+1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + '\n'
                        + 'title: ' +
                        + 'website: ' + $("#commentform_inputWebsite").val() + '\n'
                        + 'author: ' + $("#commentForm_inputName").val() + '\n';

                    var replyto = $('#commentForm_replyto').val();
                    if (replyto.length != 0) {
                        body += 'replyto: ' + replyto + '\n'
                    }

                    body += '\n'
                        + $("#commentForm_inputText").val() + '\n'
                        + '----------------------------------------\n';

                    var link = 'mailto:' + user + '@' + domain + '?subject='
                        + encodeURIComponent(subject)
                        + "&body="
                        + encodeURIComponent(body);
                    return link;
                }

                $('#commentForm').on("submit",
                    function( event ) {
                        event.preventDefault();
                        $(location).attr('href', generateMailToLink());
                    }
                );
            });
        </script>
        <form role="form" id="commentForm" action="#">
            <input name="Name" type="text" id="commentForm_inputName" placeholder="Enter your name or synonym">
            <textarea name="Text" id="commentForm_inputText" rows="10" style="resize:vertical;" placeholder="Your comment"></textarea>
            <button type="submit" id="commentForm_button">Post via email</button>
            <input name="replyto" type="hidden" id="commentForm_replyto">
        </form>
        <a href="{{ FEED_DOMAIN }}/{{ PELICAN_COMMENT_SYSTEM_FEED|format(article.slug) }}">Comment Feed</a>
        {% if article.comments %}
            {% for comment in article.comments recursive %}
                {% if loop.depth0 == 0 %}
                    {% set marginLeft = 0 %}
                {% else %}
                    {% set marginLeft = 50 %}
                {% endif %}
                <article id="comment-{{comment.id}}" style="border: 1px solid #DDDDDD; padding: 5px 0px 0px 5px; margin: 0px -1px 5px {{marginLeft}}px;">
                    <a href="{{ SITEURL }}/{{ article.url }}#comment-{{ comment.id }}" rel="bookmark" title="Permalink to this comment">Permalink</a>
                    <h4>{{ comment.author }}</h4>
                    <p>Posted on <abbr class="published" title="{{ comment.date.isoformat() }}">{{ comment.locale_date }}</abbr></p>
                    {{ comment.metadata['my_custom_metadata'] }}
                    {{ comment.content }}
                    <button onclick="reply('{{comment.id | urlencode}}');">Reply</button>
                    {% if comment.replies %}
                        {{ loop(comment.replies) }}
                    {% endif %}
                </article>
            {% endfor %}
        {% else %}
            <p>There are no comments yet.<p>
        {% endif %}
    </section>
{% endif %}
